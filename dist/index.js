(()=>{let e;let a="/nowplaying.json",t="/plugins.json",s="/playlists.json",l=e=>{application.postUiMessage(e)},o=a=>{e=new Dropbox.DropboxAuth({clientId:a||"a5kcn574s1k88k5"})},i=(a,t)=>{e.setAccessToken(a),e.setRefreshToken(t)},c=async(a,t)=>{let s=new Dropbox.Dropbox({auth:e});await s.filesUpload({path:a,mute:!0,mode:{".tag":"overwrite"},contents:JSON.stringify(t)})},n=async a=>{let t=new Dropbox.Dropbox({auth:e}),s=(await t.filesDownload({path:a})).result.fileBlob;return JSON.parse(await s.text())},p=async()=>{let e=await application.getNowPlayingTracks();await c(a,e),l({type:"message",message:"Successfully saved Now playing tracks."})},r=async()=>{let e=await n(a);await application.setNowPlayingTracks(e),l({type:"message",message:"Successfully loaded Now playing tracks."})},g=async()=>{let e=await application.getPlugins();await c(t,e),l({type:"message",message:"Successfully saved plugins."})},y=async()=>{let e=await n(s);await application.addPlaylists(e),l({type:"message",message:"Successfully added playlists."})},d=async()=>{let e=await application.getPlaylists();await c(s,e),l({type:"message",message:"Successfully saved playlists."})},m=async()=>{let e=await n(t);application.installPlugins(e)},w=async()=>{let e=document.location.host.split(".");e.shift();let a=e.join(".");l({type:"info",origin:`${document.location.protocol}//${a}`,pluginId:await application.getPluginId(),clientId:localStorage.getItem("clientId")??""})};application.onUiMessage=async e=>{switch(e.type){case"login":let a=e.accessToken,t=e.refreshToken;localStorage.setItem("access_token",a),localStorage.setItem("refresh_token",t),i(a,t);break;case"check-login":let s=localStorage.getItem("access_token");s&&l({type:"login",accessToken:s}),await w();break;case"save":await p();break;case"load":await r();break;case"save-plugins":await g();break;case"load-plugins":await m();break;case"save-playlists":await d();break;case"load-playlists":await y();break;case"set-keys":localStorage.setItem("clientId",e.clientId),o(e.clientId);break;case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token")}},application.onDeepLinkMessage=async e=>{application.postUiMessage({type:"deeplink",url:e})};let k=()=>new Promise((e,a)=>{let t=document.createElement("script");t.src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js",t.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(t),t.onload=()=>{e()},t.onerror=()=>{a()}}),u=e=>{localStorage.setItem("kb-color-mode",e)};application.onChangeTheme=async e=>{u(e)},(async()=>{await k(),o(localStorage.getItem("clientId"));let e=localStorage.getItem("access_token"),a=localStorage.getItem("refresh_token");e&&a&&i(e,a),u(await application.getTheme())})()})();