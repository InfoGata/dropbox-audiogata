const u="a5kcn574s1k88k5",p="/nowplaying.json",g="/plugins.json",d="/playlists.json";let n;const o=e=>{application.postUiMessage(e)},y=e=>{n=new Dropbox.DropboxAuth({clientId:e||u})},k=(e,s)=>{n.setAccessToken(e),n.setRefreshToken(s)},l=async(e,s)=>{await new Dropbox.Dropbox({auth:n}).filesUpload({path:e,mute:!0,mode:{".tag":"overwrite"},contents:JSON.stringify(s)})},i=async e=>{const c=await(await new Dropbox.Dropbox({auth:n}).filesDownload({path:e})).result.fileBlob.text();return JSON.parse(c)},w=async()=>{const e=await application.getNowPlayingTracks();await l(p,e),o({type:"message",message:"Successfully saved Now playing tracks."})},b=async()=>{const e=await i(p);await application.setNowPlayingTracks(e),o({type:"message",message:"Successfully loaded Now playing tracks."})},h=async()=>{const e=await application.getPlugins();await l(g,e),o({type:"message",message:"Successfully saved plugins."})},I=async()=>{const e=await i(d);await application.addPlaylists(e),o({type:"message",message:"Successfully added playlists."})},f=async()=>{const e=await application.getPlaylists();await l(d,e),o({type:"message",message:"Successfully saved playlists."})},T=async()=>{const e=await i(g);application.installPlugins(e)},P=async()=>{const s=document.location.host.split(".");s.shift();const a=s.join("."),t=`${document.location.protocol}//${a}`,c=await application.getPluginId(),r=localStorage.getItem("clientId")??"";o({type:"info",origin:t,pluginId:c,clientId:r})};application.onUiMessage=async e=>{switch(e.type){case"login":let s=e.accessToken,a=e.refreshToken;localStorage.setItem("access_token",s),localStorage.setItem("refresh_token",a),k(s,a);break;case"check-login":const t=localStorage.getItem("access_token");t&&o({type:"login",accessToken:t}),await P();break;case"save":await w();break;case"load":await b();break;case"save-plugins":await h();break;case"load-plugins":await T();break;case"save-playlists":await f();break;case"load-playlists":await I();break;case"set-keys":localStorage.setItem("clientId",e.clientId),y(e.clientId);break;case"logout":localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token");break}};application.onDeepLinkMessage=async e=>{application.postUiMessage({type:"deeplink",url:e})};const S=()=>new Promise((e,s)=>{const a="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js",t=document.createElement("script");t.src=a,t.type="text/javascript",document.getElementsByTagName("head")[0].appendChild(t),t.onload=()=>{e()},t.onerror=()=>{s()}}),m=e=>{localStorage.setItem("kb-color-mode",e)};application.onChangeTheme=async e=>{m(e)};const x=async()=>{await S();const e=localStorage.getItem("clientId");y(e);let s=localStorage.getItem("access_token"),a=localStorage.getItem("refresh_token");s&&a&&k(s,a);const t=await application.getTheme();m(t)};x();
